<script>
  const dashboardObserver = new MutationObserver(function(mutationsList, observer) {
    for (let mutation of mutationsList) {
      if (mutation.type === 'childList' && mutation.addedNodes.length) {
        const panel = mutation.addedNodes.item(0)
        if (panel.nodeType === 1 && panel.role === 'tabpanel') {
          const courseToggles = panel.querySelectorAll('.dashboard-access-list-item-expander');
          if (courseToggles?.length) {
            courseToggles.forEach((courseToggle) => {
              courseToggle.click();
            });
          }
        }
      }
    }
  });

  dashboardObserver.observe(document.querySelector('#learner'), { childList: true, subtree: true });

  const profileNavObserver = new MutationObserver(function(mutationsList, observer) {
    for (let mutation of mutationsList) {
      if (mutation.type === 'childList' && mutation.addedNodes.length) {
        const sidebar = mutation.addedNodes.item(0)
        if (sidebar.nodeType === 1 && sidebar.classList.contains('sidebar--closed--right')) {
          const toggle = sidebar.querySelector('.dashboard-header-dropdown__link')
          const dropdown = sidebar.querySelector('.dashboard-header-dropdown')
          if (toggle && dropdown) {
            const links = dropdown.querySelectorAll('.dashboard-header-dropdown a')
            links.forEach((link) => {
              link.addEventListener('click', (e) => {
                link.blur();
                toggle.click();
              }, true);
            });
          }
        }
      }
    }
  });

  profileNavObserver.observe(document.querySelector('#learner'), { childList: true, subtree: true });

  const navObserver = new MutationObserver(function(mutationsList, observer) {
    for (let mutation of mutationsList) {
      if (mutation.type === 'childList' && mutation.addedNodes.length) {
        const nav = mutation.target
        if (nav.nodeType === 1 && nav.tagName === 'NAV' && nav.classList.contains('top-bar')) {
          const toggle = nav.querySelector('.toggle-topbar button')
          if (toggle) {
            toggle.addEventListener('click', (e) => {
              e.stopPropagation();
              nav.classList.toggle('expanded')
            }, true);
          }

          const links = nav.querySelectorAll('.top-bar-section li > a')
          links.forEach((link) => {
            link.addEventListener('click', () => {
              setTimeout(() => {
                nav.classList.remove('expanded')
              }, 400);
            });
          });

          observer.disconnect();
          break;
        }
      }
    }
  });

  navObserver.observe(document.querySelector('#learner'), { childList: true, subtree: true });

  const sliderObserver = new MutationObserver(function(mutationsList, observer) {
    for (let mutation of mutationsList) {
      if (mutation.type === 'childList' && mutation.addedNodes.length && mutation.target.nodeType === 1) {
        const carousel = mutation.target.querySelector('.featured-content-carousel__list')
        if (carousel) {
          const slides = carousel.querySelectorAll('li');
          const total = slides.length;
          if (total > 1) {
            const dots = mutation.target.querySelectorAll('.featured-content-carousel__dot')
            const arrows = mutation.target.querySelectorAll('.featured-content-carousel__nav .btn')
            let x = slideIdx = 0
            let slideInterval

            function translateSlide() {
              x = slideIdx * -100
              carousel.style.transform = `translateX(${x}%)`;
              dots.forEach((dot, dotIdx) => {
                const toggler = dotIdx === slideIdx? 'add' : 'remove'
                dot.classList[toggler]('featured-content-carousel__dot--active');
              });

              arrows.forEach((arrow, arrowIdx) => {
                const arrowClass = !((slideIdx + arrowIdx) % total) ? 'btn disabled' : 'btn btn--primary'
                arrow.setAttribute('class', arrowClass)
              });
            }

            function startInterval() {
              slideInterval = setInterval(() => {
                slideIdx = (slideIdx + 1) % total
                translateSlide()
              }, 6000);
            }

            arrows.forEach((arrow, arrowIdx) => {
              arrow.addEventListener('click', (e) => {
                e.stopPropagation();
                slideIdx = arrowIdx ? slideIdx + 1 : slideIdx - 1
                translateSlide()
              });
            });

            carousel.addEventListener('mouseenter', () => {
              clearInterval(slideInterval);
            });

            carousel.addEventListener('mouseleave', () => {
              startInterval();
            });

            startInterval();
          }

          observer.disconnect();
          break;
        }
      }
    }
  });

  sliderObserver.observe(document.querySelector('#learner'), { childList: true, subtree: true });

  new ResizeObserver(() => {
    let scrollbar = window.innerWidth - document.documentElement.clientWidth;
    document.documentElement.style.setProperty('--scrollbar-width', `${scrollbar}px`);
  }).observe(document.documentElement);

  document.addEventListener('DOMContentLoaded', () => {
    if (document.cookie.match(/^(.*;)?\s*authTokenExpires\s*=\s*[^;]+(.*)?$/)) {
      document.body.classList.add('ck-dashboard-nav')
      document.body.dataset.dashboard = 'active'
    }
  });
</script>
